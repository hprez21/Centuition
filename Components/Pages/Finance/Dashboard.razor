@page "/"
@page "/finance"
@page "/finance/dashboard"
@attribute [Authorize]
@inject IAccountService AccountService
@inject ITransactionService TransactionService
@inject ICategoryService CategoryService
@inject IBudgetService BudgetService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IChatClient ChatClient
@inject ApplicationDbContext DbContext
@rendermode InteractiveServer
@using System.Text.Json
@using CentuitionApp.Components.Pages.Finance.DashboardComponents

<PageTitle>Dashboard - Centuition</PageTitle>

<div class="container-fluid py-4">
    <!-- Header Section -->
    <DashboardHeader SelectedPeriod="@selectedPeriod"
                     SelectedDate="@selectedDate"
                     SelectedYear="@selectedYear"
                     PeriodStartDate="@periodStartDate"
                     PeriodEndDate="@periodEndDate"
                     OnPeriodChanged="@ChangePeriod"
                     OnDateChanged="@OnDateChanged"
                     OnYearChanged="@OnYearChanged"
                     OnCustomRangeChanged="@OnCustomRangeChanged"
                     OnAddTransaction="@OpenQuickAddTransaction"
                     OnResetData="@OpenResetDialog" />

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <TelerikLoader Visible="true" Size="@ThemeConstants.Loader.Size.Large" />
        </div>
    }
    else
    {
        <!-- Summary Cards Row -->
        <DashboardSummaryCards TotalBalance="@totalBalance"
                               PeriodIncome="@periodIncome"
                               PeriodExpenses="@periodExpenses"
                               PeriodNetSavings="@periodNetSavings"
                               AccountsCount="@accounts.Count"
                               PeriodLabel="@GetPeriodLabel()" />

        <!-- Charts Row -->
        <div class="row mb-4 g-3">
            <!-- Spending by Category (Donut Chart) -->
            <CategorySpendingChart Data="@categorySpending" />

            <!-- Monthly Trends (Bar/Line Chart) - Always shows last 6 months -->
            <MonthlyTrendsChart Data="@monthlyTrends" />
        </div>

        <!-- Bottom Row: Accounts & Recent Transactions -->
        <div class="row g-3">
            <!-- Accounts List -->
            <AccountsList Accounts="@accounts" />

            <!-- Recent Transactions -->
            <RecentTransactionsGrid Transactions="@recentTransactions"
                                    OnAddTransaction="@OpenQuickAddTransaction" />
        </div>

        <!-- Budget Progress Section -->
        <BudgetProgressSection BudgetProgress="@budgetProgress" />
    }
</div>

<!-- Quick Add Transaction Dialog -->
<QuickAddTransactionDialog @bind-IsVisible="@showQuickAddDialog"
                           Transaction="@newTransaction"
                           @bind-DestinationAccountId="@destinationAccountId"
                           Accounts="@accounts"
                           Categories="@categories"
                           OnSave="@SaveQuickTransaction"
                           OnCancel="@CloseQuickAddDialog"
                           OnTransactionChanged="@OnQuickAddChanged" />

<!-- Reset Test Data Confirmation Dialog -->
<ResetDataDialog @bind-IsVisible="@showResetConfirmation"
                 IsResetting="@isResetting"
                 OnConfirm="@ConfirmReset"
                 OnCancel="@CancelReset" />

<TelerikNotification @ref="@notificationRef" Class="notification-container" />

<!-- AI Financial Assistant Chat - Uses tool calling to fetch data on-demand -->
<FinancialAssistantChat UserId="@userId" />

<style>
    /* Period Filter Button Group Styles */
    .period-filter .k-button-group {
        background: var(--app-surface-2);
        border-radius: var(--bs-border-radius);
        padding: 4px;
        border: 1px solid var(--app-border);
    }

    .period-filter .k-button-group .k-button {
        background: transparent;
        border: none;
        color: var(--app-text-muted);
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.15s ease-out;
    }

    .period-filter .k-button-group .k-button:hover {
        background: var(--app-border);
        color: var(--app-text);
    }

    .period-filter .k-button-group .k-button.k-selected,
    .period-filter .k-button-group .k-button:active {
        background: linear-gradient(135deg, var(--app-accent) 0%, #3db89e 100%);
        color: var(--app-bg);
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(78, 201, 176, 0.3);
    }

    /* Date Control Container - Fixed width to prevent layout shift */
    .date-control-container {
        width: 280px;
        min-width: 280px;
        display: flex;
        align-items: flex-end;
    }

    /* Accounts List Styles - Dark Theme */
    .list-group {
        background: transparent;
    }

    .list-group-item {
        background: var(--app-surface-1);
        color: var(--app-text);
        border-bottom: 1px solid var(--app-border) !important;
        transition: background-color 0.15s ease-out;
    }

    .list-group-item:hover {
        background: var(--app-surface-2);
    }

    .list-group-item:last-child {
        border-bottom: none !important;
    }
</style>