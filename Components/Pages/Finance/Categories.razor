@page "/finance/categories"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Globalization
@using CentuitionApp.Data
@using CentuitionApp.Services
@attribute [Authorize]
@inject ICategoryService CategoryService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Categories - Finance Tracker</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">Categories</h1>
                    <p class="text-muted mb-0">Organize your transactions with categories</p>
                </div>
                <div>
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   OnClick="@OpenCreateDialog"
                                   Icon="@SvgIcon.Plus">
                        Add Category
                    </TelerikButton>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Type Tabs -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <TelerikTabStrip @bind-ActiveTabIndex="@activeTabIndex">
                <TabStripTab Title="Expense Categories">
                    <div class="py-3">
                        <TelerikGrid Data="@expenseCategories"
                                     Pageable="true"
                                     PageSize="10"
                                     Sortable="true"
                                     FilterMode="@GridFilterMode.None"
                                     OnDelete="@DeleteCategory"
                                     ConfirmDelete="true"
                                     Height="450px">
                            <GridToolBarTemplate>
                                <GridSearchBox DebounceDelay="200" Placeholder="Search categories..." Width="300px" />
                            </GridToolBarTemplate>
                            <GridColumns>
                                <GridColumn Field="@nameof(Category.Name)" Title="Category Name" Width="250px">
                                    <Template>
                                        @{
                                            var category = (Category)context;
                                        }
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle me-2"
                                                 style="width: 24px; height: 24px; background-color: @category.Color;"></div>
                                            <span class="fw-medium">@category.Name</span>
                                            @if (category.IsSystem)
                                            {
                                                <TelerikBadge ThemeColor="@ThemeConstants.Badge.ThemeColor.Info"
                                                              Class="ms-2"
                                                              Position="@BadgePosition.Inline"
                                                              Rounded="@ThemeConstants.Badge.Rounded.Large"
                                                              Size="@ThemeConstants.Badge.Size.Small">
                                                    System
                                                </TelerikBadge>
                                            }
                                        </div>
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(Category.Description)" Title="Description" />
                                <GridColumn Field="@nameof(Category.Color)" Title="Color" Width="60px">
                                    <Template>
                                        @{
                                            var category = (Category)context;
                                        }
                                        <div style="width: 30px; height: 20px; background-color: @category.Color; border-radius: 4px;"></div>
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(Category.SortOrder)" Title="Order" Width="80px" />
                                <GridCommandColumn Width="180px" Title="Actions">
                                    <GridCommandButton Command="Edit" Icon="@SvgIcon.Pencil" ThemeColor="@ThemeConstants.Button.ThemeColor.Info" OnClick="@EditCategoryHandler">Edit</GridCommandButton>
                                    <GridCommandButton Command="Delete" Icon="@SvgIcon.Trash" ThemeColor="@ThemeConstants.Button.ThemeColor.Error">Delete</GridCommandButton>
                                </GridCommandColumn>
                            </GridColumns>
                        </TelerikGrid>
                    </div>
                </TabStripTab>
                <TabStripTab Title="Income Categories">
                    <div class="py-3">
                        <TelerikGrid Data="@incomeCategories"
                                     Pageable="true"
                                     PageSize="10"
                                     Sortable="true"
                                     FilterMode="@GridFilterMode.None"
                                     OnDelete="@DeleteCategory"
                                     ConfirmDelete="true"
                                     Height="450px">
                            <GridToolBarTemplate>
                                <GridSearchBox DebounceDelay="200" Placeholder="Search categories..." Width="300px" />
                            </GridToolBarTemplate>
                            <GridColumns>
                                <GridColumn Field="@nameof(Category.Name)" Title="Category Name" Width="250px">
                                    <Template>
                                        @{
                                            var category = (Category)context;
                                        }
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle me-2"
                                                 style="width: 24px; height: 24px; background-color: @category.Color;"></div>
                                            <span class="fw-medium">@category.Name</span>
                                            @if (category.IsSystem)
                                            {
                                                <TelerikBadge ThemeColor="@ThemeConstants.Badge.ThemeColor.Info"
                                                              Class="ms-2"
                                                              Position="@BadgePosition.Inline"
                                                              Rounded="@ThemeConstants.Badge.Rounded.Large"
                                                              Size="@ThemeConstants.Badge.Size.Small">
                                                    System
                                                </TelerikBadge>
                                            }
                                        </div>
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(Category.Description)" Title="Description" />
                                <GridColumn Field="@nameof(Category.Color)" Title="Color" Width="60px">
                                    <Template>
                                        @{
                                            var category = (Category)context;
                                        }
                                        <div style="width: 30px; height: 20px; background-color: @category.Color; border-radius: 4px;"></div>
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(Category.SortOrder)" Title="Order" Width="80px" />
                                <GridCommandColumn Width="180px" Title="Actions">
                                    <GridCommandButton Command="Edit" Icon="@SvgIcon.Pencil" ThemeColor="@ThemeConstants.Button.ThemeColor.Info" OnClick="@EditCategoryHandler">Edit</GridCommandButton>
                                    <GridCommandButton Command="Delete" Icon="@SvgIcon.Trash" ThemeColor="@ThemeConstants.Button.ThemeColor.Error">Delete</GridCommandButton>
                                </GridCommandColumn>
                            </GridColumns>
                        </TelerikGrid>
                    </div>
                </TabStripTab>
            </TelerikTabStrip>
        </div>
    </div>

    <!-- Category Summary Cards -->
    <div class="row mt-4 g-3">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-danger">
                        <TelerikSvgIcon Icon="@SvgIcon.ArrowDown" /> Top Expense Categories
                    </h5>
                </div>
                <div class="card-body">
                    @if (expenseCategorySpending.Any())
                    {
                        <TelerikChart Height="250px">
                            <ChartSeriesItems>
                                <ChartSeries Type="ChartSeriesType.Bar"
                                             Data="@expenseCategorySpending.Take(5)"
                                             Field="@nameof(CategorySpending.TotalAmount)"
                                             CategoryField="@nameof(CategorySpending.CategoryName)"
                                             ColorField="@nameof(CategorySpending.CategoryColor)">
                                    <ChartSeriesLabels Visible="true" Format="$#,##0" />
                                </ChartSeries>
                            </ChartSeriesItems>
                            <ChartValueAxes>
                                <ChartValueAxis>
                                    <ChartValueAxisLabels Format="$#,##0" />
                                </ChartValueAxis>
                            </ChartValueAxes>
                            <ChartTooltip Visible="true" />
                        </TelerikChart>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <TelerikSvgIcon Icon="@SvgIcon.ChartColumnClustered" Size="@ThemeConstants.SvgIcon.Size.Large" />
                            <p class="mt-2 mb-0">No spending data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0 text-success">
                        <TelerikSvgIcon Icon="@SvgIcon.ArrowUp" /> Top Income Categories
                    </h5>
                </div>
                <div class="card-body">
                    @if (incomeCategorySpending.Any())
                    {
                        <TelerikChart Height="250px">
                            <ChartSeriesItems>
                                <ChartSeries Type="ChartSeriesType.Bar"
                                             Data="@incomeCategorySpending.Take(5)"
                                             Field="@nameof(CategorySpending.TotalAmount)"
                                             CategoryField="@nameof(CategorySpending.CategoryName)"
                                             ColorField="@nameof(CategorySpending.CategoryColor)">
                                    <ChartSeriesLabels Visible="true" Format="$#,##0" />
                                </ChartSeries>
                            </ChartSeriesItems>
                            <ChartValueAxes>
                                <ChartValueAxis>
                                    <ChartValueAxisLabels Format="$#,##0" />
                                </ChartValueAxis>
                            </ChartValueAxes>
                            <ChartTooltip Visible="true" />
                        </TelerikChart>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <TelerikSvgIcon Icon="@SvgIcon.ChartColumnClustered" Size="@ThemeConstants.SvgIcon.Size.Large" />
                            <p class="mt-2 mb-0">No income data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Category Dialog -->
<TelerikWindow @bind-Visible="@showDialog"
               Width="500px"
               Modal="true">
    <WindowTitle>
        @(isEditing ? "Edit Category" : "Create Category")
    </WindowTitle>
    <WindowContent>
        <EditForm Model="@editCategory" OnValidSubmit="@SaveCategory">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Category Name <span class="text-danger">*</span></label>
                <TelerikTextBox @bind-Value="@editCategory.Name"
                                Placeholder="Enter category name"
                                Width="100%"
                                Enabled="@(!editCategory.IsSystem)" />
                <ValidationMessage For="@(() => editCategory.Name)" class="text-danger small" />
            </div>

            <div class="mb-3">
                <label class="form-label">Type <span class="text-danger">*</span></label>
                <TelerikDropDownList Data="@categoryTypes"
                                     @bind-Value="@editCategory.Type"
                                     Width="100%"
                                     Enabled="@(!isEditing)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <TelerikTextArea @bind-Value="@editCategory.Description"
                                 Placeholder="Optional description"
                                 Rows="2"
                                 Width="100%" />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Color</label>
                    <div>
                        <TelerikColorPicker @bind-Value="@categoryColor"
                                            View="@ColorPickerView.Palette" />
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sort Order</label>
                    <TelerikNumericTextBox @bind-Value="@editCategory.SortOrder"
                                           Min="0"
                                           Max="999"
                                           Width="100%" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Preview</label>
                <div class="border rounded p-3 d-flex align-items-center">
                    <div class="rounded-circle me-3"
                         style="width: 32px; height: 32px; background-color: @categoryColor;"></div>
                    <div>
                        <span class="fw-medium">@(string.IsNullOrEmpty(editCategory.Name) ? "Category Name" : editCategory.Name)</span>
                        <br />
                        <small class="text-muted">@editCategory.Type.ToString()</small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <TelerikButton ButtonType="@ButtonType.Button"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Light"
                               OnClick="@CloseDialog">
                    Cancel
                </TelerikButton>
                <TelerikButton ButtonType="@ButtonType.Submit"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                               Icon="@SvgIcon.Save">
                    @(isEditing ? "Update" : "Create")
                </TelerikButton>
            </div>
        </EditForm>
    </WindowContent>
</TelerikWindow>

<TelerikNotification @ref="@notificationRef" Class="notification-container" />

@code {
    private string? userId;
    private List<Category> categories = new();
    private List<Category> expenseCategories = new();
    private List<Category> incomeCategories = new();
    private List<CategorySpending> expenseCategorySpending = new();
    private List<CategorySpending> incomeCategorySpending = new();
    private int activeTabIndex = 0;
    
    private bool showDialog;
    private bool isEditing;
    private Category editCategory = new();
    private string categoryColor = "#6c757d";
    
    private List<CategoryType> categoryTypes = Enum.GetValues<CategoryType>().ToList();

    private TelerikNotification? notificationRef;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            await LoadCategories();
        }
    }

    private async Task LoadCategories()
    {
        if (string.IsNullOrEmpty(userId)) return;

        categories = await CategoryService.GetAllCategoriesAsync(userId);
        expenseCategories = categories.Where(c => c.Type == CategoryType.Expense).ToList();
        incomeCategories = categories.Where(c => c.Type == CategoryType.Income).ToList();
        
        var startOfMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
        expenseCategorySpending = await CategoryService.GetCategorySpendingAsync(userId, startOfMonth, endOfMonth);
        incomeCategorySpending = await CategoryService.GetIncomeByCategory(userId, startOfMonth, endOfMonth);
    }

    private void OpenCreateDialog()
    {
        isEditing = false;
        editCategory = new Category
        {
            UserId = userId,
            Type = activeTabIndex == 0 ? CategoryType.Expense : CategoryType.Income,
            SortOrder = 0
        };
        categoryColor = "#6c757d";
        showDialog = true;
    }

    private async Task EditCategoryHandler(GridCommandEventArgs args)
    {
        var category = (Category)args.Item;
        
        isEditing = true;
        editCategory = new Category
        {
            Id = category.Id,
            Name = category.Name,
            Description = category.Description,
            Type = category.Type,
            Color = category.Color,
            Icon = category.Icon,
            SortOrder = category.SortOrder,
            IsSystem = category.IsSystem,
            UserId = category.UserId
        };
        categoryColor = category.Color;
        showDialog = true;
        
        await Task.CompletedTask;
    }

    private async Task DeleteCategory(GridCommandEventArgs args)
    {
        var category = (Category)args.Item;
        
        if (category.IsSystem)
        {
            args.IsCancelled = true;
            notificationRef?.Show(new NotificationModel
            {
                Text = "System categories cannot be deleted.",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Warning,
                CloseAfter = 3000
            });
            return;
        }

        if (string.IsNullOrEmpty(userId)) return;

        var result = await CategoryService.DeleteCategoryAsync(category.Id, userId);
        
        if (result)
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "Category deleted successfully!",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                CloseAfter = 3000
            });
            await LoadCategories();
        }
        else
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "Failed to delete category.",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Error,
                CloseAfter = 3000
            });
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
    }

    private async Task SaveCategory()
    {
        editCategory.Color = categoryColor;

        try
        {
            if (isEditing)
            {
                await CategoryService.UpdateCategoryAsync(editCategory);
                notificationRef?.Show(new NotificationModel
                {
                    Text = "Category updated successfully!",
                    ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                    CloseAfter = 3000
                });
            }
            else
            {
                editCategory.UserId = userId;
                await CategoryService.CreateCategoryAsync(editCategory);
                notificationRef?.Show(new NotificationModel
                {
                    Text = "Category created successfully!",
                    ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                    CloseAfter = 3000
                });
            }

            showDialog = false;
            await LoadCategories();
        }
        catch (Exception ex)
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = $"Error: {ex.Message}",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Error,
                CloseAfter = 5000
            });
        }
    }
}
