@page "/finance/budget"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Globalization
@using CentuitionApp.Data
@using CentuitionApp.Services
@attribute [Authorize]
@inject IBudgetService BudgetService
@inject ICategoryService CategoryService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Budget - Centuition</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <h1 class="h2 mb-1">Budget</h1>
                    <p class="text-muted mb-0">Set and track your monthly spending limits</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <TelerikDropDownList Data="@months"
                                         @bind-Value="@selectedMonth"
                                         TextField="Name"
                                         ValueField="Value"
                                         OnChange="@OnMonthChanged"
                                         Width="150px" />
                    <TelerikNumericTextBox @bind-Value="@selectedYear"
                                           Format="0"
                                           Min="2020"
                                           Max="2100"
                                           Width="130px" />
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Light"
                                   OnClick="@LoadBudgetData"
                                   Icon="@SvgIcon.ArrowRotateCw">
                        Refresh
                    </TelerikButton>
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   OnClick="@OpenCreateDialog"
                                   Icon="@SvgIcon.Plus">
                        Add Budget
                    </TelerikButton>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Summary -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Budget</h6>
                    <h3 class="text-primary mb-0">@totalBudget.ToString("C2", CultureInfo.GetCultureInfo("en-US"))</h3>
                    <small class="text-muted">@budgets.Count categories budgeted</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Spent</h6>
                    <h3 class="@(totalSpent > totalBudget ? "text-danger" : "text-warning") mb-0">
                        @totalSpent.ToString("C2", CultureInfo.GetCultureInfo("en-US"))
                    </h3>
                    <small class="text-muted">@overallPercentage.ToString("0")% of budget</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Remaining</h6>
                    <h3 class="@(totalRemaining >= 0 ? "text-success" : "text-danger") mb-0">
                        @totalRemaining.ToString("C2", CultureInfo.GetCultureInfo("en-US"))
                    </h3>
                    <small class="text-muted">
                        @if (totalRemaining >= 0)
                        {
                            <span>Under budget</span>
                        }
                        else
                        {
                            <span>Over budget</span>
                        }
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Progress Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Budget vs Actual Spending</h5>
                </div>
                <div class="card-body">
                    @if (budgetProgress.Any())
                    {
                        <TelerikChart Height="350px">
                            <ChartSeriesItems>
                                <ChartSeries Type="ChartSeriesType.Bar"
                                             Data="@budgetProgress"
                                             Field="@nameof(BudgetProgress.BudgetAmount)"
                                             CategoryField="@nameof(BudgetProgress.CategoryName)"
                                             Name="Budget"
                                             Color="#3498DB">
                                </ChartSeries>
                                <ChartSeries Type="ChartSeriesType.Bar"
                                             Data="@budgetProgress"
                                             Field="@nameof(BudgetProgress.SpentAmount)"
                                             CategoryField="@nameof(BudgetProgress.CategoryName)"
                                             Name="Spent"
                                             Color="#F39C12">
                                </ChartSeries>
                            </ChartSeriesItems>
                            <ChartCategoryAxes>
                                <ChartCategoryAxis />
                            </ChartCategoryAxes>
                            <ChartValueAxes>
                                <ChartValueAxis>
                                    <ChartValueAxisLabels Format="$#,##0" />
                                </ChartValueAxis>
                            </ChartValueAxes>
                            <ChartLegend Visible="true" Position="ChartLegendPosition.Top" />
                            <ChartTooltip Visible="true" />
                        </TelerikChart>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <TelerikSvgIcon Icon="@SvgIcon.ChartColumnClustered" Size="@ThemeConstants.SvgIcon.Size.ExtraLarge" />
                            <p class="mt-2">No budgets set for this month</p>
                            <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                           OnClick="@OpenCreateDialog">
                                Create Your First Budget
                            </TelerikButton>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Budget Progress Cards -->
    @if (budgetProgress.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Budget Progress</h5>
                        <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Light"
                                       Size="@ThemeConstants.Button.Size.Small"
                                       OnClick="@CopyToNextMonth"
                                       Icon="@SvgIcon.Copy">
                            Copy to Next Month
                        </TelerikButton>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            @foreach (var progress in budgetProgress)
                            {
                                <BudgetProgressCard Progress="@progress" />
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Budget Grid -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
            <h5 class="mb-0">Budget Details</h5>
        </div>
        <div class="card-body">
            <TelerikGrid Data="@budgets"
                         Pageable="true"
                         PageSize="10"
                         Sortable="true"
                         OnDelete="@DeleteBudget"
                         ConfirmDelete="true"
                         Height="400px">
                <GridColumns>
                    <GridColumn Title="Category" Width="200px">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle me-2"
                                     style="width: 16px; height: 16px; background-color: @(budget.Category?.Color ?? "#6c757d");"></div>
                                <span>@(budget.Category?.Name ?? "Unknown")</span>
                            </div>
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(Budget.Amount)" Title="Budget Amount" Width="150px" TextAlign="@ColumnTextAlign.Center">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <span class="fw-medium">@budget.Amount.ToString("C2", CultureInfo.GetCultureInfo("en-US"))</span>
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(Budget.SpentAmount)" Title="Spent" Width="150px" TextAlign="@ColumnTextAlign.Center">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <span class="@(budget.SpentAmount > budget.Amount ? "text-danger" : "")">
                                @budget.SpentAmount.ToString("C2", CultureInfo.GetCultureInfo("en-US"))
                            </span>
                        </Template>
                    </GridColumn>
                    <GridColumn Title="Remaining" Width="150px" TextAlign="@ColumnTextAlign.Center">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <span class="@(budget.RemainingAmount >= 0 ? "text-success" : "text-danger") fw-medium">
                                @budget.RemainingAmount.ToString("C2", CultureInfo.GetCultureInfo("en-US"))
                            </span>
                        </Template>
                    </GridColumn>
                    <GridColumn Title="Progress" Width="200px">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 100px;">
                                    <TelerikProgressBar Value="@((double)Math.Min(budget.PercentageUsed, 100))"
                                                        Max="100"
                                                        Class="@(budget.IsOverBudget ? "progress-danger" : budget.PercentageUsed >= 80 ? "progress-warning" : "")">
                                    </TelerikProgressBar>
                                </div>
                                <span class="small">@Math.Round(budget.PercentageUsed, 0)%</span>
                            </div>
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(Budget.IsActive)" Title="Status" Width="100px">
                        <Template>
                            @{
                                var budget = (Budget)context;
                            }
                            <TelerikBadge ThemeColor="@(budget.IsActive ? ThemeConstants.Badge.ThemeColor.Success : ThemeConstants.Badge.ThemeColor.Light)"
                                          Rounded="@ThemeConstants.Badge.Rounded.Large"
                                          Position="@BadgePosition.Inline">
                                @(budget.IsActive ? "Active" : "Inactive")
                            </TelerikBadge>
                        </Template>
                    </GridColumn>
                    <GridCommandColumn Width="180px" Title="Actions">
                        <GridCommandButton Command="Edit" Icon="@SvgIcon.Pencil" ThemeColor="@ThemeConstants.Button.ThemeColor.Info" OnClick="@EditBudgetHandler">Edit</GridCommandButton>
                        <GridCommandButton Command="Delete" Icon="@SvgIcon.Trash" ThemeColor="@ThemeConstants.Button.ThemeColor.Error">Delete</GridCommandButton>
                    </GridCommandColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    </div>
</div>

<!-- Create/Edit Budget Dialog -->
<TelerikWindow @bind-Visible="@showDialog"
               Width="500px"
               Modal="true">
    <WindowTitle>
        @(isEditing ? "Edit Budget" : "Create Budget")
    </WindowTitle>
    <WindowContent>
        <EditForm Model="@editBudget" OnValidSubmit="@SaveBudget">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Category <span class="text-danger">*</span></label>
                <TelerikDropDownList Data="@availableCategories"
                                     @bind-Value="@editBudget.CategoryId"
                                     TextField="Name"
                                     ValueField="Id"
                                     DefaultText="Select category"
                                     Width="100%"
                                     Enabled="@(!isEditing)"
                                     OnChange="@OnCategoryChanged">
                    <ItemTemplate Context="categoryItem">
                        @{
                            var category = categoryItem as Category;
                        }
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle me-2"
                                 style="width: 12px; height: 12px; background-color: @category?.Color;"></div>
                            <span>@category?.Name</span>
                        </div>
                    </ItemTemplate>
                </TelerikDropDownList>
            </div>

            <div class="mb-3">
                <label class="form-label">Budget Amount <span class="text-danger">*</span></label>
                <TelerikNumericTextBox @bind-Value="@editBudget.Amount"
                                       Format="$#,##0.00"
                                       Min="0"
                                       Placeholder="0.00"
                                       Width="100%" />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Month</label>
                    <TelerikDropDownList Data="@months"
                                         @bind-Value="@editBudget.Month"
                                         TextField="Name"
                                         ValueField="Value"
                                         Width="100%"
                                         Enabled="@(!isEditing)" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Year</label>
                    <TelerikNumericTextBox @bind-Value="@editBudget.Year"
                                           Format="0"
                                           Min="2020"
                                           Max="2100"
                                           Width="100%"
                                           Enabled="@(!isEditing)" />
                </div>
            </div>

            <div class="mb-3">
                <TelerikCheckBox @bind-Value="@editBudget.IsActive" Id="isActive" />
                <label for="isActive" class="ms-2">Active Budget</label>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <TelerikButton ButtonType="@ButtonType.Button"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Light"
                               OnClick="@CloseDialog">
                    Cancel
                </TelerikButton>
                <TelerikButton ButtonType="@ButtonType.Submit"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                               Icon="@SvgIcon.Save">
                    @(isEditing ? "Update" : "Create")
                </TelerikButton>
            </div>
        </EditForm>
    </WindowContent>
</TelerikWindow>

<TelerikNotification @ref="@notificationRef" Class="notification-container" />

@code {
    private string? userId;
    private List<Budget> budgets = new();
    private List<BudgetProgress> budgetProgress = new();
    private List<Category> expenseCategories = new();
    private List<Category> availableCategories = new();
    
    private int selectedMonth = DateTime.Today.Month;
    private int selectedYear = DateTime.Today.Year;
    
    private decimal totalBudget;
    private decimal totalSpent;
    private decimal totalRemaining;
    private decimal overallPercentage;
    
    private bool showDialog;
    private bool isEditing;
    private Budget editBudget = new();
    
    private List<MonthOption> months = Enumerable.Range(1, 12)
        .Select(m => new MonthOption { Value = m, Name = new DateTime(2000, m, 1).ToString("MMMM") })
        .ToList();

    private TelerikNotification? notificationRef;

    private class MonthOption
    {
        public int Value { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            await LoadCategories();
            await LoadBudgetData();
        }
    }

    private async Task LoadCategories()
    {
        if (string.IsNullOrEmpty(userId)) return;

        var categories = await CategoryService.GetAllCategoriesAsync(userId);
        expenseCategories = categories.Where(c => c.Type == CategoryType.Expense).ToList();
    }

    private async Task LoadBudgetData()
    {
        if (string.IsNullOrEmpty(userId)) return;

        budgets = await BudgetService.GetBudgetsAsync(userId, selectedYear, selectedMonth);
        budgetProgress = await BudgetService.GetBudgetProgressAsync(userId, selectedYear, selectedMonth);
        
        totalBudget = budgets.Sum(b => b.Amount);
        totalSpent = budgets.Sum(b => b.SpentAmount);
        totalRemaining = totalBudget - totalSpent;
        overallPercentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
        
        var budgetedCategoryIds = budgets.Select(b => b.CategoryId).ToHashSet();
        availableCategories = expenseCategories.Where(c => !budgetedCategoryIds.Contains(c.Id)).ToList();
    }

    private async Task OnMonthChanged(object value)
    {
        await LoadBudgetData();
    }

    private void OnCategoryChanged(object value)
    {        
        if (value is int categoryId)
        {
            var category = availableCategories.FirstOrDefault(c => c.Id == categoryId) 
                           ?? expenseCategories.FirstOrDefault(c => c.Id == categoryId);
            editBudget.Name = category?.Name ?? "Budget";
        }
    }

    private void OpenCreateDialog()
    {
        if (!availableCategories.Any())
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "All expense categories already have budgets for this month.",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Warning,
                CloseAfter = 3000
            });
            return;
        }

        isEditing = false;
        var firstCategory = availableCategories.First();
        editBudget = new Budget
        {
            UserId = userId ?? string.Empty,
            Month = selectedMonth,
            Year = selectedYear,
            IsActive = true,
            CategoryId = firstCategory.Id,
            Name = firstCategory.Name
        };
        showDialog = true;
    }

    private async Task EditBudgetHandler(GridCommandEventArgs args)
    {
        var budget = (Budget)args.Item;
        
        isEditing = true;
        editBudget = new Budget
        {
            Id = budget.Id,
            Name = budget.Name,
            Amount = budget.Amount,
            CategoryId = budget.CategoryId,
            Month = budget.Month,
            Year = budget.Year,
            IsActive = budget.IsActive,
            UserId = budget.UserId
        };
        showDialog = true;
        
        await Task.CompletedTask;
    }

    private async Task DeleteBudget(GridCommandEventArgs args)
    {
        var budget = (Budget)args.Item;
        
        if (string.IsNullOrEmpty(userId)) return;

        var result = await BudgetService.DeleteBudgetAsync(budget.Id, userId);
        
        if (result)
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "Budget deleted successfully!",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                CloseAfter = 3000
            });
            await LoadBudgetData();
        }
        else
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "Failed to delete budget.",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Error,
                CloseAfter = 3000
            });
        }
    }

    private void CloseDialog()
    {
        showDialog = false;
    }

    private async Task SaveBudget()
    {
        if (string.IsNullOrEmpty(userId)) return;

        editBudget.UserId = userId;
        
        var category = expenseCategories.FirstOrDefault(c => c.Id == editBudget.CategoryId);
        editBudget.Name = category?.Name ?? "Budget";

        try
        {
            if (isEditing)
            {
                await BudgetService.UpdateBudgetAsync(editBudget);
                notificationRef?.Show(new NotificationModel
                {
                    Text = "Budget updated successfully!",
                    ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                    CloseAfter = 3000
                });
            }
            else
            {
                await BudgetService.CreateBudgetAsync(editBudget);
                notificationRef?.Show(new NotificationModel
                {
                    Text = "Budget created successfully!",
                    ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
                    CloseAfter = 3000
                });
            }

            showDialog = false;
            await LoadBudgetData();
        }
        catch (Exception ex)
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = $"Error: {ex.Message}",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Error,
                CloseAfter = 5000
            });
        }
    }

    private async Task CopyToNextMonth()
    {
        if (string.IsNullOrEmpty(userId) || !budgets.Any())
        {
            notificationRef?.Show(new NotificationModel
            {
                Text = "No budgets to copy.",
                ThemeColor = ThemeConstants.Notification.ThemeColor.Warning,
                CloseAfter = 3000
            });
            return;
        }

        await BudgetService.CopyBudgetsToNextMonthAsync(userId, selectedYear, selectedMonth);

        notificationRef?.Show(new NotificationModel
        {
            Text = "Budgets copied to next month!",
            ThemeColor = ThemeConstants.Notification.ThemeColor.Success,
            CloseAfter = 3000
        });
    }
}